AWSTemplateFormatVersion: 2010-09-09

Parameters:
  Name:
    Type: String
    Description: The name of the lightsail instance

Outputs: {}

Resources:

  InstanceKeyPair:
    Type: Custom::LightsailKeyPair
    Properties:
      ServiceToken: !ImportValue cfn-custom-resource-lightsail-key-pair
      KeyPairName: !Sub lightsail-key-pair-${Name}

  InstanceKeyPairParam:
    Type: Custom::SecureStringParameter
    Properties:
      ServiceToken: !ImportValue cfn-custom-resource-secure-string-parameter
      Name: !Sub /lightsail/${Name}/private-key
      Description: !Sub Private Key for the lightsail key pair for instance ${Name}
      Type: SecureString
      Value: !GetAtt InstanceKeyPair.PrivateKey

  StaticIp:
    Type: Custom::LightsailStaticIp
    Properties:
      ServiceToken: !ImportValue cfn-custom-resource-lightsail-static-ip
      StaticIpName: !Sub lightsail-static-ip-${Name}

  Instance:
    Type: Custom::LightsailInstance
    Properties:
      ServiceToken: !ImportValue cfn-custom-resource-lightsail-instance
      InstanceName: !Ref Name
      KeyPairName: !Ref InstanceKeyPair
      PrivateKey: !GetAtt InstanceKeyPair.PrivateKey
      AvailabilityZone: us-east-1a
      StaticIpName: !Ref StaticIp
