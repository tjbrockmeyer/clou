AWSTemplateFormatVersion: 2010-09-09

Transform: AWS::Serverless-2016-10-31

Parameters:
  BucketName:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /global/bucket-name

Globals:
  Function:
    Environment:
      Variables:
        PYTHONPATH: "/var/task/site-packages:/var/runtime"

Outputs:
  LightsailInstanceFunctionArn:
    Value: !GetAtt LightsailInstanceCustomResource.Arn
    Export:
      Name: cfn-custom-resource-lightsail-instance
  LightsailKeyPairFunctionArn:
    Value: !GetAtt LightsailKeyPairCustomResource.Arn
    Export:
      Name: cfn-custom-resource-lightsail-key-pair
  LightsailStaticIpFunctionArn:
    Value: !GetAtt LightsailStaticIpCustomResource.Arn
    Export:
      Name: cfn-custom-resource-lightsail-static-ip
  SecureStringParameterFunctionArn:
    Value: !GetAtt SecureStringParameterCustomResource.Arn
    Export:
      Name: cfn-custom-resource-secure-string-parameter

Resources:

  LightsailInstanceCustomResource:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: cfn-custom-resource-lightsail-instance
      Handler: lambda_function.handler
      Runtime: python3.8
      Timeout: 120
      CodeUri:
        Bucket: !Ref BucketName
        Key: code/custom-resource/lightsail-instance.zip
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - lightsail:CreateInstances
              - lightsail:GetInstanceState
              - lightsail:GetInstance
              - lightsail:DeleteInstance
              - lightsail:AttachStaticIp
              - lightsail:DetachStaticIp
            Resource: !Sub arn:aws:lightsail:*:${AWS::AccountId}:*

  LightsailKeyPairCustomResource:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: cfn-custom-resource-lightsail-key-pair
      Handler: lambda_function.handler
      Runtime: python3.8
      Timeout: 120
      CodeUri:
        Bucket: !Ref BucketName
        Key: code/custom-resource/lightsail-key-pair.zip
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - lightsail:CreateKeyPair
              - lightsail:DeleteKeyPair
            Resource: !Sub arn:aws:lightsail:*:${AWS::AccountId}:*

  LightsailStaticIpCustomResource:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: cfn-custom-resource-lightsail-static-ip
      Handler: lambda_function.handler
      Runtime: python3.8
      Timeout: 120
      CodeUri:
        Bucket: !Ref BucketName
        Key: code/custom-resource/lightsail-static-ip.zip
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - lightsail:GetStaticIp
              - lightsail:ReleaseStaticIp
              - lightsail:GetInstanceState
              - lightsail:AttachStaticIp
              - lightsail:DetachStaticIp
              - lightsail:AllocateStaticIp
            Resource: !Sub arn:aws:lightsail:*:${AWS::AccountId}:*

  SecureStringParameterCustomResource:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: cfn-custom-resource-secure-string-parameter
      Handler: lambda_function.handler
      Runtime: python3.8
      Timeout: 120
      CodeUri:
        Bucket: !Ref BucketName
        Key: code/custom-resource/secure-string-parameter.zip
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - ssm:PutParameter
              - ssm:DeleteParameter
            Resource: !Sub arn:aws:ssm:*:${AWS::AccountId}:parameter/*
